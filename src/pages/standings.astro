---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Standings | SYNAPSE 2026" activePage="standings">
  <section class="leaderboard-section">
    <div class="container">

      <div class="page-header-box">
        <h1 class="page-title">Tournament Leaderboard</h1>
        <div id="leadingBannerContainer"></div>
      </div>

      <!-- TOP LAYER: Filter Tabs (MVP moved to last) -->
      <div class="filter-tabs" id="filterTabs">
        <button class="filter-btn active" data-filter="overall">Overall</button>
        <button class="filter-btn" data-filter="day1">Day 1</button>
        <button class="filter-btn" data-filter="day2">Day 2</button>
        <button class="filter-btn" data-filter="day3">Day 3</button>
        <button class="filter-btn" data-filter="finals">Finals</button>
        <button class="filter-btn" data-filter="mvp">MVP</button>
      </div>

      <!-- MID LAYER 1: Group Selector (Now shows for Day 1, 2, 3) -->
      <div id="groupFilterMenu" class="mid-menu-container" style="display: none;">
        <div class="selector-label">Select Group:</div>
        <div class="button-group">
            <button class="group-btn" onclick="selectGroup('A')">Group A</button>
            <button class="group-btn" onclick="selectGroup('B')">Group B</button>
            <button class="group-btn" onclick="selectGroup('C')">Group C</button>
            <button class="group-btn" onclick="selectGroup('D')">Group D</button>
        </div>
      </div>

      <!-- MID LAYER 2: Match Selector -->
      <div id="matchFilterMenu" class="mid-menu-container" style="display: none;">
        <div class="selector-label">Select Match:</div>
        <div class="button-group" id="matchButtonList"></div>
      </div>

      <!-- MAIN CONTENT -->
      <div id="standingsContent" class="content-fade-in"></div>

    </div>
  </section>
</Layout>

<style is:global>
  .page-header-box { text-align: center; margin-bottom: 2rem; }
  .selector-label { color: var(--accent-cyan); font-weight: 700; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 10px; width: 100%; text-align: center; }
  
  .mid-menu-container { 
    background: rgba(0,0,0,0.4); 
    border: 1px solid rgba(255,255,255,0.1);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .button-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }

  .group-btn, .match-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    padding: 8px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
  }

  .group-btn.active { background: var(--accent-cyan); color: #000; border-color: var(--accent-cyan); box-shadow: 0 0 15px rgba(0, 174, 239, 0.4); }
  .match-btn.active { background: var(--accent-orange); color: #fff; border-color: var(--accent-orange); box-shadow: 0 0 15px rgba(255, 140, 0, 0.4); }

  /* MVP Rank Style */
  .rank-row-1 { background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent); border-left: 4px solid gold; }
  .kill-highlight { color: #ff4d4d; font-weight: 800; }
  
  .content-fade-in { animation: fadeIn 0.4s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script is:inline>
  let standingsData = [];
  let playersData = [];
  let currentFilter = 'overall';
  let selectedGroup = 'A';
  let selectedMatch = 'M1';

  async function init() {
    const t = Date.now();
    const [sRes, pRes] = await Promise.all([
      fetch(`/data/standings.json?v=${t}`),
      fetch(`/data/players.json?v=${t}`)
    ]);
    standingsData = await sRes.json();
    playersData = await pRes.json();
    
    render('overall');
    setupTabListeners();
  }

  function render(filter) {
    currentFilter = filter;
    const gMenu = document.getElementById('groupFilterMenu');
    const mMenu = document.getElementById('matchFilterMenu');
    const content = document.getElementById('standingsContent');

    // Default: hide selectors
    gMenu.style.display = 'none';
    mMenu.style.display = 'none';

    if (filter === 'overall') {
      renderOverall();
    } else if (filter === 'mvp') {
      renderMVP();
    } else {
      // Day 1, 2, 3 or Finals
      gMenu.style.display = 'flex';
      mMenu.style.display = 'flex';
      updateGroupButtons();
      updateMatchButtons(filter);
      renderMatchResult(filter);
    }
  }

  function renderOverall() {
    const sorted = [...standingsData].sort((a,b) => b.stats.overall.total_pts - a.stats.overall.total_pts);
    let html = `<h3>Overall Leaderboard</h3><div class="table-container"><table class="leaderboard-table">
      <thead><tr><th>#</th><th>Team</th><th>Group</th><th>Matches</th><th>Finish</th><th>Place</th><th>Total</th></tr></thead><tbody>`;
    
    sorted.forEach((t, i) => {
      const s = t.stats.overall;
      html += `<tr class="${i < 3 ? 'rank-row-'+(i+1) : ''}">
        <td>${i+1}</td>
        <td>${t.team_name}</td>
        <td>${t.group}</td>
        <td>${s.matches_played}</td>
        <td>${s.finish_pts}</td>
        <td>${s.pos_pts}</td>
        <td><strong>${s.total_pts}</strong></td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    document.getElementById('standingsContent').innerHTML = html;
  }

  function renderMatchResult(day) {
    // Filter teams by group and then get their match specific data
    const filteredTeams = standingsData.filter(t => t.group === selectedGroup);
    const sorted = filteredTeams.map(t => ({
        name: t.team_name,
        stats: t.stats[day]?.[selectedMatch] || { place_pts: 0, kill_pts: 0, total: 0, wwcd: false }
    })).sort((a,b) => b.stats.total - a.stats.total);

    let html = `<h3>Day ${day.slice(-1)} - Group ${selectedGroup} - Match ${selectedMatch.slice(-1)}</h3>`;
    html += `<div class="table-container"><table class="leaderboard-table">
      <thead><tr><th>#</th><th>Team</th><th>Finish Pts</th><th>Place Pts</th><th>Total</th><th>WWCD</th></tr></thead><tbody>`;
    
    sorted.forEach((t, i) => {
      html += `<tr class="${t.stats.wwcd ? 'wwcd-row' : ''}">
        <td>${i+1}</td>
        <td>${t.name}</td>
        <td>${t.stats.kill_pts}</td>
        <td>${t.stats.place_pts}</td>
        <td><strong>${t.stats.total}</strong></td>
        <td>${t.stats.wwcd ? 'üèÜ' : '-'}</td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    document.getElementById('standingsContent').innerHTML = html;
  }

  function renderMVP() {
    const sorted = [...playersData].sort((a,b) => b.stats.total_kills - a.stats.total_kills).slice(0, 20);
    let html = `<h3>Top Fraggers (MVP)</h3><div class="table-container"><table class="leaderboard-table">
      <thead><tr><th>Rank</th><th>Player Name</th><th>Team</th><th>Total Kills</th></tr></thead><tbody>`;
    
    sorted.forEach((p, i) => {
      html += `<tr class="${i === 0 ? 'rank-row-1' : ''}">
        <td>#${i+1}</td>
        <td><strong>${p.name}</strong></td>
        <td>${p.team_name}</td>
        <td class="kill-highlight">${p.stats.total_kills} Kills</td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    document.getElementById('standingsContent').innerHTML = html;
  }

  // Button Logic
  window.selectGroup = (g) => { 
    selectedGroup = g; 
    render(currentFilter); 
  };
  
  window.selectMatch = (m) => { 
    selectedMatch = m; 
    render(currentFilter); 
  };

  function updateGroupButtons() {
    document.querySelectorAll('.group-btn').forEach(btn => {
      btn.classList.toggle('active', btn.innerText.includes(selectedGroup));
    });
  }

  function updateMatchButtons(day) {
    const list = document.getElementById('matchButtonList');
    const matches = ['M1', 'M2', 'M3', 'M4'];
    list.innerHTML = matches.map(m => `
      <button class="match-btn ${m === selectedMatch ? 'active' : ''}" onclick="selectMatch('${m}')">
        Match ${m.slice(-1)}
      </button>
    `).join('');
  }

  function setupTabListeners() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render(btn.dataset.filter);
      });
    });
  }

  init();
</script>
