---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Standings | MAVERICKS x SYNAPSE BGMI 2026" description="Live leaderboard and standings for SYNAPSE MAMC BGMI 2026 tournament." activePage="standings">
  <section class="leaderboard-section">
    <div class="container">
      <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
        <h1 class="page-title" style="margin:0;">Overall Standings</h1>
        <div class="live-indicator">
          <span class="live-dot"></span>
          <span>Live</span>
        </div>
        <button id="viewToggle" class="btn-sm" style="background:transparent; border:1px solid rgba(255,255,255,0.1); color:var(--text-muted); cursor:pointer; font-size:0.65rem; padding:2px 8px; border-radius:4px; margin-left:10px;">
          Switch View
        </button>
      </div>

      <!-- Leading Team Banner (will be populated by JavaScript) -->
      <div id="leadingTeamBannerContainer"></div>

      <div class="filter-tabs" id="filterTabs">
        <button class="filter-btn active" data-filter="all">
          <span>Overall</span>
        </button>
        <button class="filter-btn" data-filter="day1">
          <span>Day 1</span>
        </button>
        <button class="filter-btn" data-filter="day2">
          <span>Day 2</span>
        </button>
        <button class="filter-btn" data-filter="day3">
          <span>Day 3</span>
        </button>
        <button class="filter-btn" data-filter="finals">
          <span>Finals</span>
        </button>
      </div>

      <div id="matchFilters" style="display: none; justify-content: center; gap: 10px; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="filter-btn btn-sm" data-match="1">M1</button>
        <button class="filter-btn btn-sm" data-match="2">M2</button>
        <button class="filter-btn btn-sm" data-match="3">M3</button>
        <button class="filter-btn btn-sm" data-match="4">M4</button>
        <button class="filter-btn btn-sm" data-match="5">M5</button>
      </div>

      <div id="overallFilters" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="filter-btn btn-sm active" data-group="all">Overall</button>
        <button class="filter-btn btn-sm" data-group="A">Group A</button>
        <button class="filter-btn btn-sm" data-group="B">Group B</button>
        <button class="filter-btn btn-sm" data-group="C">Group C</button>
        <button class="filter-btn btn-sm" data-group="D">Group D</button>
        <button class="filter-btn btn-sm" data-group="mvp">MVP</button>
      </div>

      <div id="overallContainer" style="display:none;">
        <div id="groupView">
          <div class="group-grid">
            <div class="group-block" id="groupA"></div>
            <div class="group-block" id="groupB"></div>
            <div class="group-block" id="groupC"></div>
            <div class="group-block" id="groupD"></div>
          </div>
        </div>
        <div id="mvpArea" class="mvp-area" style="display:none;"></div>
      </div>

      <div class="table-container">
        <table class="leaderboard-table" id="leaderboardTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Team</th>
              <th class="hide-mobile">Group</th>
              <th class="hide-mobile">Matches</th>
              <th class="hide-mobile">Finish Pts</th>
              <th class="hide-mobile">Position Pts</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <tr class="coming-soon-row">
              <td colspan="7" style="text-align:center; color: var(--text-muted); font-style: italic;">Data Coming Soon</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="last-updated" id="lastUpdated">
        Last updated: --:--
      </div>
    </div>
  </section>
</Layout>

<script>
  // ========================================
  // CANVAS FIRE PARTICLE SYSTEM
  // ========================================

  class FireParticle {
    constructor(x, y, canvas) {
      this.x = x;
      this.y = y;
      this.canvas = canvas;
      this.size = Math.random() * 8 + 2;
      this.speedY = Math.random() * 3 + 1;
      this.speedX = (Math.random() - 0.5) * 2;
      this.life = 1;
      this.decay = Math.random() * 0.015 + 0.005;
      this.color = this.getFireColor();
    }

    getFireColor() {
      const colors = [
        { r: 255, g: 69, b: 0, a: 1 },    // Red-Orange
        { r: 255, g: 140, b: 0, a: 1 },   // Dark Orange
        { r: 255, g: 200, b: 0, a: 1 },   // Gold
        { r: 255, g: 255, b: 0, a: 0.8 }, // Yellow
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    update() {
      this.y -= this.speedY;
      this.x += this.speedX;
      this.life -= this.decay;
      this.size *= 0.98;
    }

    draw(ctx) {
      if (this.life <= 0) return;

      const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size);
      gradient.addColorStop(0, `rgba(${"$"}{this.color.r}, ${"$"}{this.color.g}, ${"$"}{this.color.b}, ${"$"}{this.life * this.color.a})`);
      gradient.addColorStop(0.5, `rgba(${"$"}{this.color.r}, ${"$"}{this.color.g}, ${"$"}{this.color.b}, ${"$"}{this.life * 0.5})`);
      gradient.addColorStop(1, `rgba(${"$"}{this.color.r}, ${"$"}{this.color.g}, ${"$"}{this.color.b}, 0)`);

      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      ctx.fill();
    }

    isAlive() {
      return this.life > 0;
    }
  }

  class FireEffect {
    constructor(element) {
      this.element = element;
      this.canvas = document.createElement('canvas');
      this.ctx = this.canvas.getContext('2d');
      this.particles = [];
      this.setupCanvas();
      this.animate();
    }

    setupCanvas() {
      this.canvas.style.position = 'absolute';
      this.canvas.style.top = '0';
      this.canvas.style.left = '0';
      this.canvas.style.width = '100%';
      this.canvas.style.height = '100%';
      this.canvas.style.pointerEvents = 'none';
      this.canvas.style.zIndex = '1';

      const rect = this.element.getBoundingClientRect();
      this.canvas.width = rect.width;
      this.canvas.height = rect.height;

      this.element.style.position = 'relative';
      this.element.appendChild(this.canvas);

      // Resize handler
      window.addEventListener('resize', () => this.handleResize());
    }

    handleResize() {
      const rect = this.element.getBoundingClientRect();
      this.canvas.width = rect.width;
      this.canvas.height = rect.height;
    }

    createParticles() {
      const width = this.canvas.width;
      const height = this.canvas.height;

      // Create particles along the bottom
      for (let i = 0; i < 3; i++) {
        const x = Math.random() * width;
        const y = height - 5;
        this.particles.push(new FireParticle(x, y, this.canvas));
      }
    }

    animate() {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

      // Create new particles
      this.createParticles();

      // Update and draw particles
      this.particles = this.particles.filter(particle => {
        particle.update();
        particle.draw(this.ctx);
        return particle.isAlive();
      });

      requestAnimationFrame(() => this.animate());
    }
  }

  // Initialize fire effect when banner is created
  function initFireEffect() {
    const banner = document.querySelector('.leading-team-banner');
    if (banner && !banner.dataset.fireInitialized) {
      new FireEffect(banner);
      banner.dataset.fireInitialized = 'true';
    }
  }

  // ========================================
  // STANDINGS PAGE LOGIC
  // ========================================

  const filterTabs = document.getElementById('filterTabs');
  const matchFilters = document.getElementById('matchFilters');
  const overallFilters = document.getElementById('overallFilters');

  filterTabs?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const btn = target.closest('.filter-btn') as HTMLElement;
    if (!btn) return;

    const filter = btn.dataset.filter;

    // Update active state
    filterTabs.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Show/hide match filters based on selection
    if (filter === 'all') {
      if (matchFilters) matchFilters.style.display = 'none';
      if (overallFilters) overallFilters.style.display = 'flex';
    } else if (filter === 'finals') {
      if (matchFilters) {
        matchFilters.style.display = 'flex';
        // Add extra match button for finals (6 matches)
        const existingBtns = matchFilters.querySelectorAll('.filter-btn');
        if (existingBtns.length === 5) {
          const m6 = document.createElement('button');
          m6.className = 'filter-btn btn-sm';
          m6.dataset.match = '6';
          m6.textContent = 'M6';
          matchFilters.appendChild(m6);
        }
      }
      if (overallFilters) overallFilters.style.display = 'none';
    } else {
      if (matchFilters) {
        matchFilters.style.display = 'flex';
        // Remove M6 button for day matches
        const m6Btn = matchFilters.querySelector('[data-match="6"]');
        if (m6Btn) m6Btn.remove();
      }
      if (overallFilters) overallFilters.style.display = 'none';
    }
  });

  // View toggle
  const viewToggle = document.getElementById('viewToggle');
  let isTableView = true;

  viewToggle?.addEventListener('click', () => {
    isTableView = !isTableView;
    const tableContainer = document.querySelector('.table-container') as HTMLElement;
    const overallContainer = document.getElementById('overallContainer');

    if (tableContainer) tableContainer.style.display = isTableView ? 'block' : 'none';
    if (overallContainer) overallContainer.style.display = isTableView ? 'none' : 'block';
  });

  // Match filter clicks
  matchFilters?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const btn = target.closest('.filter-btn') as HTMLElement;
    if (!btn) return;

    matchFilters.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });

  // Group filter clicks
  overallFilters?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const btn = target.closest('.filter-btn') as HTMLElement;
    if (!btn) return;

    overallFilters.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });

  // Render Leading Team Banner (FIXED)
  async function renderLeadingTeamBanner() {
    const container = document.getElementById('leadingTeamBannerContainer');
    if (!container) return;

    try {
      const response = await fetch('/data/standings.json');
      if (!response.ok) return;

      const standings = await response.json();
      if (!standings || standings.length === 0) return;

      // Find the team with highest total score (FIXED: uses stats.overall.total_pts)
      const leadingTeam = standings.reduce((max: any, team: any) => 
        team.stats.overall.total_pts > max.stats.overall.total_pts ? team : max
      , standings[0]);

      if (!leadingTeam) return;

      // Create and insert banner
const banner = document.createElement('div');
banner.className = 'leading-team-banner';

const heading = document.createElement('h2');
heading.className = 'leading-team-text';
heading.textContent = `${leadingTeam.team_name} is Leading ðŸ”¥`; // Using textContent is safer

banner.appendChild(heading);
container.innerHTML = '';
container.appendChild(banner);

// Initialize fire effect after banner is in DOM
setTimeout(initFireEffect, 100);

    } catch (error) {
      console.log('Could not render leading team banner:', error);
    }
  }

  // Helper function to escape HTML
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Load leading team banner on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', renderLeadingTeamBanner);
  } else {
    renderLeadingTeamBanner();
  }
</script>
