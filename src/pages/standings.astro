---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Standings | MAVERICKS x SYNAPSE BGMI 2026" description="Live leaderboard and standings for SYNAPSE MAMC BGMI 2026 tournament." activePage="standings">
  <section class="leaderboard-section">
    <div class="container">
      <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
        <h1 class="page-title" style="margin:0;">Overall Standings</h1>
        <div class="live-indicator">
          <span class="live-dot"></span>
          <span>Live</span>
        </div>
      </div>

      <!-- Leading Team Banner with Ember Particles -->
      <div id="leadingTeamBannerContainer"></div>

      <!-- Filter Tabs -->
      <div class="filter-tabs" id="filterTabs">
        <button class="filter-btn active" data-filter="overall"><span>Overall</span></button>
        <button class="filter-btn" data-filter="day1"><span>Day 1</span></button>
        <button class="filter-btn" data-filter="day2"><span>Day 2</span></button>
        <button class="filter-btn" data-filter="day3"><span>Day 3</span></button>
        <button class="filter-btn" data-filter="finals"><span>Finals</span></button>
      </div>

      <!-- View Toggle for Overall -->
      <div id="overallViewToggle" style="display: none; text-align: center; margin-bottom: 1rem;">
        <button class="view-toggle-btn active" data-view="combined">Combined</button>
        <button class="view-toggle-btn" data-view="grouped">By Group</button>
      </div>

      <!-- Content Container (includes selectors) -->
      <div id="standingsContent"></div>

      <!-- Legend -->
      <div style="margin-top: 2rem; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 8px; font-size: 0.85rem; color: var(--text-muted);">
        <strong style="color: var(--text-primary);">Legend:</strong> 
        üèÜ = Chicken Dinners (WWCD) | 
        Place Pts = Position Points | 
        Kill Pts = Elimination Points
      </div>
    </div>
  </section>
</Layout>

<style is:global>
  .table-container {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 2rem;
  }

  .leaderboard-table {
    min-width: 700px;
  }

  .group-header {
    background: linear-gradient(90deg, rgba(0, 174, 239, 0.2), transparent);
    border-left: 4px solid var(--accent-cyan);
    padding: 1rem;
    margin: 2rem 0 1rem 0;
    border-radius: 8px;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--accent-cyan);
  }

  .match-header {
    background: linear-gradient(90deg, rgba(255, 140, 0, 0.2), transparent);
    border-left: 4px solid var(--accent-orange);
    padding: 0.75rem 1rem;
    margin: 1.5rem 0 0.75rem 0;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 700;
    color: var(--accent-orange);
  }

  .view-toggle-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text-muted);
    padding: 0.5rem 1.5rem;
    margin: 0 0.25rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }

  .view-toggle-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .view-toggle-btn.active {
    background: var(--accent-orange);
    border-color: var(--accent-orange);
    color: white;
  }

  .selector-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    align-items: center;
  }

  .selector-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text-muted);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    font-weight: 500;
  }

  .selector-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
  }

  .selector-btn.active {
    background: var(--accent-orange);
    border-color: var(--accent-orange);
    color: white;
    box-shadow: 0 0 15px rgba(255, 140, 0, 0.5);
  }

  @media (max-width: 768px) {
    .selector-buttons {
      gap: 0.4rem;
    }

    .selector-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
  }

  /* ============================================
     EMBER PARTICLES EFFECT FOR LEADING BANNER
     ============================================ */

  .leading-team-banner {
    background: linear-gradient(135deg, rgba(255, 69, 0, 0.15) 0%, rgba(139, 0, 0, 0.1) 100%);
    border: 2px solid #ff4500;
    border-radius: 12px;
    padding: 1.125rem 1.5rem;
    margin: 1.5rem auto;
    text-align: center;
    position: relative;
    overflow: hidden;
    box-shadow: 
      0 0 30px rgba(255, 69, 0, 0.6),
      0 0 60px rgba(255, 140, 0, 0.4),
      inset 0 0 30px rgba(255, 69, 0, 0.2);
    animation: fire-pulse 2s ease-in-out infinite;
    max-width: 450px;
  }

  /* EMBER EFFECT - Floating ember particles */
  .leading-team-banner::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
      radial-gradient(circle at 15% 85%, rgba(255, 140, 0, 0.6) 0%, transparent 3%),
      radial-gradient(circle at 45% 70%, rgba(255, 100, 0, 0.5) 0%, transparent 2%),
      radial-gradient(circle at 75% 90%, rgba(255, 200, 0, 0.4) 0%, transparent 2.5%),
      radial-gradient(circle at 25% 60%, rgba(255, 69, 0, 0.7) 0%, transparent 2%),
      radial-gradient(circle at 85% 75%, rgba(255, 140, 0, 0.5) 0%, transparent 3%),
      radial-gradient(circle at 55% 95%, rgba(255, 150, 0, 0.6) 0%, transparent 2%),
      radial-gradient(circle at 35% 80%, rgba(255, 100, 0, 0.4) 0%, transparent 2.5%),
      radial-gradient(circle at 65% 65%, rgba(255, 180, 0, 0.5) 0%, transparent 2%),
      radial-gradient(circle at 90% 85%, rgba(255, 120, 0, 0.6) 0%, transparent 3%),
      radial-gradient(circle at 10% 75%, rgba(255, 160, 0, 0.4) 0%, transparent 2%);
    background-size: 100% 100%;
    animation: ember-float 8s ease-in-out infinite;
    z-index: 0;
    opacity: 0.8;
  }

  /* Animated border with fire colors */
  .leading-team-banner::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(
      45deg,
      #ff4500 0%,
      #ff8c00 25%,
      #ffd700 50%,
      #ff8c00 75%,
      #ff4500 100%
    );
    background-size: 300% 300%;
    animation: fire-border-flow 4s linear infinite;
    z-index: -1;
    border-radius: inherit;
    opacity: 0.8;
  }

  .leading-team-banner h2 {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    font-weight: 700;
    color: #ff4500;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 
      0 0 10px rgba(255, 140, 0, 1),
      0 0 20px rgba(255, 69, 0, 0.8),
      0 0 30px rgba(255, 200, 0, 0.6),
      0 2px 4px rgba(0, 0, 0, 0.5);
    animation: fire-text-flicker 2s ease-in-out infinite;
    margin: 0;
    position: relative;
    z-index: 1;
  }

  /* KEYFRAMES */

  /* Ember floating animation - moves embers upward and side-to-side */
  @keyframes ember-float {
    0% {
      transform: translateY(0) translateX(0);
      opacity: 0.8;
    }
    25% {
      transform: translateY(-8px) translateX(3px);
      opacity: 1;
    }
    50% {
      transform: translateY(-15px) translateX(-2px);
      opacity: 0.9;
    }
    75% {
      transform: translateY(-25px) translateX(4px);
      opacity: 0.7;
    }
    100% {
      transform: translateY(-35px) translateX(0);
      opacity: 0.5;
    }
  }

  /* Fire pulse animation */
  @keyframes fire-pulse {
    0%, 100% {
      box-shadow: 
        0 0 30px rgba(255, 69, 0, 0.6),
        0 0 60px rgba(255, 140, 0, 0.4),
        inset 0 0 30px rgba(255, 69, 0, 0.2);
    }
    50% {
      box-shadow: 
        0 0 40px rgba(255, 69, 0, 0.8),
        0 0 80px rgba(255, 140, 0, 0.6),
        inset 0 0 40px rgba(255, 69, 0, 0.3);
    }
  }

  /* Border flow animation */
  @keyframes fire-border-flow {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }

  /* Text flicker animation */
  @keyframes fire-text-flicker {
    0%, 100% {
      text-shadow: 
        0 0 10px rgba(255, 140, 0, 1),
        0 0 20px rgba(255, 69, 0, 0.8),
        0 0 30px rgba(255, 200, 0, 0.6),
        0 2px 4px rgba(0, 0, 0, 0.5);
      opacity: 1;
    }
    25% {
      text-shadow: 
        0 0 15px rgba(255, 140, 0, 1),
        0 0 25px rgba(255, 69, 0, 0.9),
        0 0 40px rgba(255, 200, 0, 0.7),
        0 2px 4px rgba(0, 0, 0, 0.5);
      opacity: 0.95;
    }
    50% {
      text-shadow: 
        0 0 20px rgba(255, 140, 0, 1),
        0 0 30px rgba(255, 69, 0, 1),
        0 0 50px rgba(255, 200, 0, 0.8),
        0 2px 4px rgba(0, 0, 0, 0.5);
      opacity: 1;
    }
    75% {
      text-shadow: 
        0 0 12px rgba(255, 140, 0, 1),
        0 0 22px rgba(255, 69, 0, 0.85),
        0 0 35px rgba(255, 200, 0, 0.65),
        0 2px 4px rgba(0, 0, 0, 0.5);
      opacity: 0.98;
    }
  }

  .leaderboard-table tbody tr.rank-1 {
    background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.05));
    border-left: 3px solid var(--accent-orange);
  }

  .leaderboard-table tbody tr.rank-1 td:first-child {
    color: var(--accent-orange);
    font-weight: 700;
  }

  .leaderboard-table tbody tr.rank-2 {
    background: rgba(192, 192, 192, 0.05);
  }

  .leaderboard-table tbody tr.rank-3 {
    background: rgba(205, 127, 50, 0.05);
  }

  .wwcd-winner {
    background: rgba(255, 215, 0, 0.15) !important;
    border-left: 3px solid gold !important;
  }

  @media (max-width: 768px) {
    .leading-team-banner {
      padding: 0.9rem 1.125rem;
      margin: 1rem auto;
      max-width: 90%;
    }

    .leading-team-banner h2 {
      font-size: 1.125rem;
      letter-spacing: 1px;
    }

    .leaderboard-table {
      font-size: 0.85rem;
    }

    .leaderboard-table th,
    .leaderboard-table td {
      padding: 0.5rem 0.4rem;
    }

    .group-header, .match-header {
      font-size: 0.9rem;
      padding: 0.6rem 0.8rem;
    }
  }
</style>

<script is:inline>
  // ========================================
  // DATA MANAGEMENT WITH SELECTORS
  // ========================================
  let standingsData = [];
  let currentFilter = 'overall';
  let currentView = 'combined';
  let currentGroup = null;  // For group selection
  let currentMatch = null;  // For match selection

  async function loadStandings() {
    try {
      const timestamp = new Date().getTime();
      const response = await fetch('/data/standings.json?t=' + timestamp);

      if (!response.ok) throw new Error('Failed to fetch');
      standingsData = await response.json();
      console.log('‚úÖ Loaded', standingsData.length, 'teams from standings.json');

      createLeadingBanner();
      renderContent('overall');
      setupFilters();
      setupViewToggle();
    } catch (error) {
      console.error('‚ùå Error:', error);
      document.getElementById('standingsContent').innerHTML = 
        '<div style="text-align:center; padding: 2rem; color: var(--accent-red);">Failed to load standings</div>';
    }
  }

  function createLeadingBanner() {
    const container = document.getElementById('leadingTeamBannerContainer');
    if (!container || standingsData.length === 0) return;

    const leader = standingsData.reduce((max, team) => {
      const maxScore = max.stats?.overall?.total_pts || 0;
      const teamScore = team.stats?.overall?.total_pts || 0;
      return teamScore > maxScore ? team : max;
    }, standingsData[0]);

    const banner = document.createElement('div');
    banner.className = 'leading-team-banner';
    banner.innerHTML = '<h2>' + escapeHtml(leader.team_name) + ' is Leading üî•</h2>';

    container.innerHTML = '';
    container.appendChild(banner);

    console.log('üî• Leading banner with ember particles created');
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function renderContent(filter) {
    currentFilter = filter;
    const content = document.getElementById('standingsContent');
    const viewToggle = document.getElementById('overallViewToggle');

    if (filter === 'overall') {
      viewToggle.style.display = 'block';
      if (currentView === 'grouped') {
        renderGroupSelector();
      } else {
        renderOverallCombined();
      }
    } else {
      viewToggle.style.display = 'none';
      renderMatchSelector(filter);
    }
  }

  // ========================================
  // GROUP SELECTOR (For "By Group" view)
  // ========================================
  function renderGroupSelector() {
    const groups = {};
    standingsData.forEach(team => {
      if (!groups[team.group]) groups[team.group] = [];
      groups[team.group].push(team);
    });

    const groupNames = Object.keys(groups).sort();

    // Set default group if not selected
    if (!currentGroup || !groupNames.includes(currentGroup)) {
      currentGroup = groupNames[0];
    }

    // Create group selector buttons
    let html = '<div style="text-align: center; margin-bottom: 1.5rem;">';
    html += '<div class="selector-buttons">';
    groupNames.forEach(groupName => {
      const activeClass = groupName === currentGroup ? 'active' : '';
      html += '<button class="selector-btn ' + activeClass + '" onclick="selectGroup(\'' + groupName + '\')">';
      html += groupName + '</button>';
    });
    html += '</div></div>';

    // Render selected group data
    const groupTeams = groups[currentGroup].sort((a, b) => 
      (b.stats.overall.total_pts || 0) - (a.stats.overall.total_pts || 0)
    );

    html += '<div class="group-header">' + currentGroup + '</div>';
    html += '<div class="table-container"><table class="leaderboard-table"><thead><tr>';
    html += '<th>Rank</th><th>Team</th><th>Matches</th>';
    html += '<th>Place Pts</th><th>Kill Pts</th><th>Total</th><th>üèÜ</th></tr></thead><tbody>';

    groupTeams.forEach((team, index) => {
      const rank = index + 1;
      const stats = team.stats.overall;
      const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';
      const wwcd = stats.wwcd_count > 0 ? 'üèÜ'.repeat(stats.wwcd_count) : '-';

      html += '<tr class="' + rankClass + '"><td><strong>' + rank + '</strong></td>';
      html += '<td><div style="display:flex;align-items:center;gap:8px;">';
      html += '<span class="team-logo-mini">' + team.team_logo + '</span>';
      html += '<span>' + team.team_name + '</span></div></td>';
      html += '<td>' + (stats.matches_played || 0) + '</td>';
      html += '<td>' + (stats.finish_pts || stats.pos_pts || 0) + '</td>';
      html += '<td>' + ((stats.total_pts || 0) - (stats.finish_pts || stats.pos_pts || 0)) + '</td>';
      html += '<td><strong>' + (stats.total_pts || 0) + '</strong></td>';
      html += '<td>' + wwcd + '</td></tr>';
    });

    html += '</tbody></table></div>';
    document.getElementById('standingsContent').innerHTML = html;
  }

  window.selectGroup = function(groupName) {
    currentGroup = groupName;
    renderGroupSelector();
  };

  // ========================================
  // MATCH SELECTOR (For Day views)
  // ========================================
  function renderMatchSelector(day) {
    const matchKeys = day === 'finals' ? ['M1', 'M2', 'M3', 'M4', 'M5', 'M6'] : ['M1', 'M2', 'M3', 'M4'];

    // Set default match if not selected
    if (!currentMatch || !matchKeys.includes(currentMatch)) {
      currentMatch = matchKeys[0];
    }

    // Create match selector buttons
    let html = '<div style="text-align: center; margin-bottom: 1.5rem;">';
    html += '<div class="selector-buttons">';
    matchKeys.forEach(matchKey => {
      const activeClass = matchKey === currentMatch ? 'active' : '';
      const matchNumber = matchKey.substring(1);
      html += '<button class="selector-btn ' + activeClass + '" onclick="selectMatch(\'' + matchKey + '\')">';
      html += 'Match ' + matchNumber + '</button>';
    });
    html += '</div></div>';

    // Render selected match data
    const matchNumber = currentMatch.substring(1);
    const teamsWithData = standingsData.map(team => {
      const matchData = team.stats[day]?.[currentMatch];
      return {
        ...team,
        matchStats: matchData || { place_pts: 0, kill_pts: 0, total: 0, wwcd: false }
      };
    }).filter(team => team.matchStats.total > 0 || team.matchStats.place_pts > 0 || team.matchStats.kill_pts > 0);

    if (teamsWithData.length === 0) {
      html += '<div class="match-header">Match ' + matchNumber + ' - No data yet</div>';
      html += '<div style="text-align:center; padding: 2rem; color: var(--text-muted);">Match data not available</div>';
      document.getElementById('standingsContent').innerHTML = html;
      return;
    }

    teamsWithData.sort((a, b) => b.matchStats.total - a.matchStats.total);

    html += '<div class="match-header">Match ' + matchNumber + '</div>';
    html += '<div class="table-container"><table class="leaderboard-table"><thead><tr>';
    html += '<th>Rank</th><th>Team</th><th>Group</th>';
    html += '<th>Place Pts</th><th>Kill Pts</th><th>Total</th><th>üèÜ</th></tr></thead><tbody>';

    teamsWithData.forEach((team, index) => {
      const rank = index + 1;
      const stats = team.matchStats;
      const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';
      const wwcdClass = stats.wwcd ? 'wwcd-winner' : '';
      const wwcd = stats.wwcd ? 'üèÜ' : '-';

      html += '<tr class="' + rankClass + ' ' + wwcdClass + '">';
      html += '<td><strong>' + rank + '</strong></td>';
      html += '<td><div style="display:flex;align-items:center;gap:8px;">';
      html += '<span class="team-logo-mini">' + team.team_logo + '</span>';
      html += '<span>' + team.team_name + '</span></div></td>';
      html += '<td>' + team.group + '</td>';
      html += '<td>' + (stats.place_pts || 0) + '</td>';
      html += '<td>' + (stats.kill_pts || 0) + '</td>';
      html += '<td><strong>' + (stats.total || 0) + '</strong></td>';
      html += '<td>' + wwcd + '</td></tr>';
    });

    html += '</tbody></table></div>';
    document.getElementById('standingsContent').innerHTML = html;
  }

  window.selectMatch = function(matchKey) {
    currentMatch = matchKey;
    renderMatchSelector(currentFilter);
  };

  function renderOverallCombined() {
    const teams = [...standingsData].sort((a, b) => 
      (b.stats.overall.total_pts || 0) - (a.stats.overall.total_pts || 0)
    );

    let html = '<div class="table-container"><table class="leaderboard-table"><thead><tr>';
    html += '<th>Rank</th><th>Team</th><th>Group</th><th>Matches</th>';
    html += '<th>Place Pts</th><th>Kill Pts</th><th>Total</th><th>üèÜ</th></tr></thead><tbody>';

    teams.forEach((team, index) => {
      const rank = index + 1;
      const stats = team.stats.overall;
      const rankClass = rank <= 3 ? 'rank-' + rank : '';
      const wwcd = stats.wwcd_count > 0 ? 'üèÜ'.repeat(stats.wwcd_count) : '-';

      html += '<tr class="' + rankClass + '"><td><strong>' + rank + '</strong></td>';
      html += '<td><div style="display:flex;align-items:center;gap:8px;">';
      html += '<span class="team-logo-mini">' + team.team_logo + '</span>';
      html += '<span>' + team.team_name + '</span></div></td>';
      html += '<td>' + team.group + '</td>';
      html += '<td>' + (stats.matches_played || 0) + '</td>';
      html += '<td>' + (stats.finish_pts || stats.pos_pts || 0) + '</td>';
      html += '<td>' + ((stats.total_pts || 0) - (stats.finish_pts || stats.pos_pts || 0)) + '</td>';
      html += '<td><strong>' + (stats.total_pts || 0) + '</strong></td>';
      html += '<td>' + wwcd + '</td></tr>';
    });

    html += '</tbody></table></div>';
    document.getElementById('standingsContent').innerHTML = html;
  }

  function setupFilters() {
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMatch = null; // Reset match selection when changing filter
        renderContent(btn.dataset.filter);
      });
    });
  }

  function setupViewToggle() {
    const viewBtns = document.querySelectorAll('.view-toggle-btn');
    viewBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        viewBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentView = btn.dataset.view;
        currentGroup = null; // Reset group selection when changing view
        if (currentFilter === 'overall') {
          renderContent('overall');
        }
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadStandings);
  } else {
    loadStandings();
  }
</script>
