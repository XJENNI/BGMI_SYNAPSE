---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Standings | MAVERICKS x SYNAPSE BGMI 2026" description="Live leaderboard and standings for SYNAPSE MAMC BGMI 2026 tournament." activePage="standings">
  <section class="leaderboard-section">
    <div class="container">
      <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
        <h1 class="page-title" style="margin:0;">Overall Standings</h1>
        <div class="live-indicator">
          <span class="live-dot"></span>
          <span>Live</span>
        </div>
      </div>

      <!-- Leading Team Banner with DOOM Fire -->
      <div id="leadingTeamBannerContainer"></div>

      <!-- Filter Tabs -->
      <div class="filter-tabs" id="filterTabs">
        <button class="filter-btn active" data-filter="overall"><span>Overall</span></button>
        <button class="filter-btn" data-filter="day1"><span>Day 1</span></button>
        <button class="filter-btn" data-filter="day2"><span>Day 2</span></button>
        <button class="filter-btn" data-filter="day3"><span>Day 3</span></button>
        <button class="filter-btn" data-filter="finals"><span>Finals</span></button>
      </div>

      <!-- Standings Table - Scrollable on mobile -->
      <div class="table-container" style="overflow-x: auto;">
        <table class="leaderboard-table" id="leaderboardTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Team</th>
              <th>Group</th>
              <th>Matches</th>
              <th>Place Pts</th>
              <th>Kill Pts</th>
              <th>Total</th>
              <th>üèÜ</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <tr>
              <td colspan="8" style="text-align:center; padding: 2rem; color: var(--text-muted);">
                <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                <div>Loading standings...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Legend -->
      <div style="margin-top: 2rem; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 8px; font-size: 0.85rem; color: var(--text-muted);">
        <strong style="color: var(--text-primary);">Legend:</strong> 
        üèÜ = Chicken Dinners (WWCD) | 
        Place Pts = Position Points | 
        Kill Pts = Elimination Points
      </div>
    </div>
  </section>
</Layout>

<style is:global>
  /* Table container - allow horizontal scroll on all devices */
  .table-container {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Ensure table doesn't shrink */
  .leaderboard-table {
    min-width: 700px; /* Minimum width to show all columns properly */
  }

  /* Reduced Banner Size - 25% Smaller */
  .leading-team-banner {
    background: linear-gradient(180deg, rgba(20, 0, 0, 0.95) 0%, rgba(40, 10, 0, 0.9) 100%);
    border: 2px solid var(--accent-orange);
    border-radius: 12px;
    padding: 1.125rem 1.5rem;
    margin: 1.5rem auto;
    text-align: center;
    position: relative;
    overflow: visible;
    box-shadow: 
      0 0 30px rgba(255, 69, 0, 0.8),
      0 0 60px rgba(255, 140, 0, 0.6),
      inset 0 0 45px rgba(255, 69, 0, 0.2);
    animation: banner-pulse 3s ease-in-out infinite;
    max-width: 450px;
  }

  .leading-team-banner h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    background: linear-gradient(90deg, #ff8c00, #ffd700, #ff8c00);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradient-shift 3s ease infinite;
    position: relative;
    z-index: 2;
  }

  @keyframes banner-pulse {
    0%, 100% {
      box-shadow: 0 0 30px rgba(255, 69, 0, 0.8), 0 0 60px rgba(255, 140, 0, 0.6), inset 0 0 45px rgba(255, 69, 0, 0.2);
    }
    50% {
      box-shadow: 0 0 37.5px rgba(255, 69, 0, 1), 0 0 75px rgba(255, 140, 0, 0.8), inset 0 0 52.5px rgba(255, 69, 0, 0.3);
    }
  }

  @keyframes gradient-shift {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 100% center; }
  }

  /* Highlight first place */
  .leaderboard-table tbody tr.rank-1 {
    background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.05));
    border-left: 3px solid var(--accent-orange);
  }

  .leaderboard-table tbody tr.rank-1 td:first-child {
    color: var(--accent-orange);
    font-weight: 700;
  }

  /* Top 3 styling */
  .leaderboard-table tbody tr.rank-2 {
    background: rgba(192, 192, 192, 0.05);
  }

  .leaderboard-table tbody tr.rank-3 {
    background: rgba(205, 127, 50, 0.05);
  }

  /* Mobile optimization */
  @media (max-width: 768px) {
    .leading-team-banner {
      padding: 0.9rem 1.125rem;
      margin: 1rem auto;
      max-width: 90%;
    }

    .leading-team-banner h2 {
      font-size: 1.125rem;
    }

    /* Reduce font size slightly on mobile for better fit */
    .leaderboard-table {
      font-size: 0.85rem;
    }

    .leaderboard-table th,
    .leaderboard-table td {
      padding: 0.5rem 0.4rem;
    }
  }
</style>

<script is:inline>
  // ========================================
  // DOOM PSX FIRE EFFECT
  // ========================================
  class DoomFire {
    constructor(element) {
      this.element = element;
      this.canvas = document.createElement('canvas');
      this.ctx = this.canvas.getContext('2d');
      this.fireWidth = 60;
      this.fireHeight = 30;
      this.firePixels = [];
      this.palette = [
        { r: 7, g: 7, b: 7 }, { r: 31, g: 7, b: 7 }, { r: 47, g: 15, b: 7 },
        { r: 71, g: 15, b: 7 }, { r: 87, g: 23, b: 7 }, { r: 103, g: 31, b: 7 },
        { r: 119, g: 31, b: 7 }, { r: 143, g: 39, b: 7 }, { r: 159, g: 47, b: 7 },
        { r: 175, g: 63, b: 7 }, { r: 191, g: 71, b: 7 }, { r: 199, g: 71, b: 7 },
        { r: 223, g: 79, b: 7 }, { r: 223, g: 87, b: 7 }, { r: 223, g: 87, b: 7 },
        { r: 215, g: 95, b: 7 }, { r: 215, g: 95, b: 7 }, { r: 215, g: 103, b: 15 },
        { r: 207, g: 111, b: 15 }, { r: 207, g: 119, b: 15 }, { r: 207, g: 127, b: 15 },
        { r: 207, g: 135, b: 23 }, { r: 199, g: 135, b: 23 }, { r: 199, g: 143, b: 23 },
        { r: 199, g: 151, b: 31 }, { r: 191, g: 159, b: 31 }, { r: 191, g: 159, b: 31 },
        { r: 191, g: 167, b: 39 }, { r: 191, g: 167, b: 39 }, { r: 191, g: 175, b: 47 },
        { r: 183, g: 175, b: 47 }, { r: 183, g: 183, b: 47 }, { r: 183, g: 183, b: 55 },
        { r: 207, g: 207, b: 111 }, { r: 223, g: 223, b: 159 }, { r: 239, g: 239, b: 199 },
        { r: 255, g: 255, b: 255 }
      ];
      this.setupCanvas();
      this.initFire();
      this.animate();
    }

    setupCanvas() {
      this.canvas.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;image-rendering:pixelated;';
      this.canvas.width = this.fireWidth;
      this.canvas.height = this.fireHeight;
      this.element.style.position = 'relative';
      this.element.appendChild(this.canvas);
    }

    initFire() {
      const pixelCount = this.fireWidth * this.fireHeight;
      for (let i = 0; i < pixelCount; i++) this.firePixels[i] = 0;
      for (let i = 0; i < this.fireWidth; i++) {
        this.firePixels[(this.fireHeight - 1) * this.fireWidth + i] = 36;
      }
    }

    spreadFire(from) {
      const rand = Math.round(Math.random() * 3.0) & 3;
      const to = from - this.fireWidth - rand + 1;
      const decay = rand & 1;
      if (to >= 0 && to < this.firePixels.length) {
        this.firePixels[to] = Math.max(0, this.firePixels[from] - decay);
      }
    }

    doFire() {
      for (let x = 0; x < this.fireWidth; x++) {
        for (let y = 1; y < this.fireHeight; y++) {
          this.spreadFire(y * this.fireWidth + x);
        }
      }
    }

    drawFire() {
      const imageData = this.ctx.createImageData(this.fireWidth, this.fireHeight);
      for (let i = 0; i < this.firePixels.length; i++) {
        const color = this.palette[this.firePixels[i]];
        const pixelIndex = i * 4;
        imageData.data[pixelIndex] = color.r;
        imageData.data[pixelIndex + 1] = color.g;
        imageData.data[pixelIndex + 2] = color.b;
        imageData.data[pixelIndex + 3] = 255;
      }
      this.ctx.putImageData(imageData, 0, 0);
    }

    animate() {
      this.doFire();
      this.drawFire();
      requestAnimationFrame(() => this.animate());
    }
  }

  // ========================================
  // DATA MANAGEMENT & TABLE RENDERING
  // ========================================
  let standingsData = [];
  let currentFilter = 'overall';
  let doomFireInstance = null;

  async function loadStandings() {
    try {
      const response = await fetch('/data/standings.json');
      if (!response.ok) throw new Error('Failed to fetch standings');
      standingsData = await response.json();
      console.log('‚úÖ Loaded', standingsData.length, 'teams from standings.json');

      createLeadingBanner();
      renderTable('overall');
      setupFilters();
    } catch (error) {
      console.error('‚ùå Error loading standings:', error);
      document.getElementById('leaderboardBody').innerHTML = 
        '<tr><td colspan="8" style="text-align:center; padding: 2rem; color: var(--accent-red);">Failed to load standings. Please refresh.</td></tr>';
    }
  }

  function createLeadingBanner() {
    const container = document.getElementById('leadingTeamBannerContainer');
    if (!container || standingsData.length === 0) return;

    // Find leader based on overall total_pts from JSON
    const leader = standingsData.reduce((max, team) => {
      const maxScore = max.stats?.overall?.total_pts || 0;
      const teamScore = team.stats?.overall?.total_pts || 0;
      return teamScore > maxScore ? team : max;
    }, standingsData[0]);

    console.log('üèÜ Leader:', leader.team_name, 'with', leader.stats.overall.total_pts, 'points');

    const banner = document.createElement('div');
    banner.className = 'leading-team-banner';
    banner.id = 'doomBanner';
    banner.innerHTML = '<h2>' + leader.team_name + ' is Leading üî•</h2>';

    container.innerHTML = '';
    container.appendChild(banner);

    setTimeout(() => {
      if (!banner.dataset.fireInitialized) {
        doomFireInstance = new DoomFire(banner);
        banner.dataset.fireInitialized = 'true';
        console.log('üî• DOOM fire initialized');
      }
    }, 200);
  }

  function calculateDayStats(team, day) {
    const dayData = team.stats[day];
    if (!dayData) return { place_pts: 0, kill_pts: 0, total: 0, wwcd: 0, matches: 0 };

    let place_pts = 0, kill_pts = 0, total = 0, wwcd = 0, matches = 0;

    Object.keys(dayData).forEach(matchKey => {
      const match = dayData[matchKey];
      if (match && typeof match === 'object') {
        const matchPlacePts = match.place_pts || 0;
        const matchKillPts = match.kill_pts || 0;

        place_pts += matchPlacePts;
        kill_pts += matchKillPts;
        total += match.total || (matchPlacePts + matchKillPts);

        if (match.wwcd) wwcd++;
        if (matchPlacePts > 0 || matchKillPts > 0) matches++;
      }
    });

    return { place_pts, kill_pts, total, wwcd, matches };
  }

  function renderTable(filter) {
    currentFilter = filter;
    const tbody = document.getElementById('leaderboardBody');

    if (standingsData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 2rem;">No data available</td></tr>';
      return;
    }

    // Calculate stats based on filter - ALL FROM JSON
    const teamsWithStats = standingsData.map(team => {
      let stats;

      if (filter === 'overall') {
        // Use overall stats directly from JSON
        const overall = team.stats.overall;
        stats = {
          place_pts: overall.finish_pts || overall.pos_pts || 0,
          kill_pts: overall.pos_pts || 0,
          total: overall.total_pts || 0,
          wwcd: overall.wwcd_count || 0,
          matches: overall.matches_played || 0
        };
      } else {
        // Calculate from day/finals data in JSON
        stats = calculateDayStats(team, filter);
      }

      return { ...team, displayStats: stats };
    });

    // Sort by total points descending
    teamsWithStats.sort((a, b) => b.displayStats.total - a.displayStats.total);

    // Render rows - ALL DATA FROM JSON
    let html = '';
    teamsWithStats.forEach((team, index) => {
      const rank = index + 1;
      const stats = team.displayStats;
      const rankClass = rank <= 3 ? `rank-${rank}` : '';

      const wwcdDisplay = stats.wwcd > 0 ? 'üèÜ'.repeat(stats.wwcd) : '-';

      html += `
        <tr class="${rankClass}">
          <td><strong>${rank}</strong></td>
          <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span class="team-logo-mini">${team.team_logo}</span>
              <span class="team-name-text">${team.team_name}</span>
            </div>
          </td>
          <td>${team.group}</td>
          <td>${stats.matches}</td>
          <td>${stats.place_pts}</td>
          <td>${stats.kill_pts}</td>
          <td><strong>${stats.total}</strong></td>
          <td>${wwcdDisplay}</td>
        </tr>
      `;
    });

    tbody.innerHTML = html;
    console.log('‚úÖ Table rendered:', filter, '-', teamsWithStats.length, 'teams');
  }

  function setupFilters() {
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const filter = btn.dataset.filter;
        renderTable(filter);
      });
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadStandings);
  } else {
    loadStandings();
  }
</script>
