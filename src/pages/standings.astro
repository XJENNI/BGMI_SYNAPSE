---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Standings | MAVERICKS x SYNAPSE BGMI 2026" description="Live leaderboard and standings for SYNAPSE MAMC BGMI 2026 tournament." activePage="standings">
  <section class="leaderboard-section">
    <div class="container">
      <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
        <h1 class="page-title" style="margin:0;">Overall Standings</h1>
        <div class="live-indicator">
          <span class="live-dot"></span>
          <span>Live</span>
        </div>
        <button id="viewToggle" class="btn-sm" style="background:transparent; border:1px solid rgba(255,255,255,0.1); color:var(--text-muted); cursor:pointer; font-size:0.65rem; padding:2px 8px; border-radius:4px; margin-left:10px;">
          Switch View
        </button>
      </div>

      <!-- Leading Team Banner (will be populated by JavaScript) -->
      <div id="leadingTeamBannerContainer"></div>

      <div class="filter-tabs" id="filterTabs">
        <button class="filter-btn active" data-filter="all">
          <span>Overall</span>
        </button>
        <button class="filter-btn" data-filter="day1">
          <span>Day 1</span>
        </button>
        <button class="filter-btn" data-filter="day2">
          <span>Day 2</span>
        </button>
        <button class="filter-btn" data-filter="day3">
          <span>Day 3</span>
        </button>
        <button class="filter-btn" data-filter="finals">
          <span>Finals</span>
        </button>
      </div>

      <div id="matchFilters" style="display: none; justify-content: center; gap: 10px; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="filter-btn btn-sm" data-match="1">M1</button>
        <button class="filter-btn btn-sm" data-match="2">M2</button>
        <button class="filter-btn btn-sm" data-match="3">M3</button>
        <button class="filter-btn btn-sm" data-match="4">M4</button>
        <button class="filter-btn btn-sm" data-match="5">M5</button>
      </div>

      <div id="overallFilters" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="filter-btn btn-sm active" data-group="all">Overall</button>
        <button class="filter-btn btn-sm" data-group="A">Group A</button>
        <button class="filter-btn btn-sm" data-group="B">Group B</button>
        <button class="filter-btn btn-sm" data-group="C">Group C</button>
        <button class="filter-btn btn-sm" data-group="D">Group D</button>
        <button class="filter-btn btn-sm" data-group="mvp">MVP</button>
      </div>

      <div id="overallContainer" style="display:none;">
        <div id="groupView">
          <div class="group-grid">
            <div class="group-block" id="groupA"></div>
            <div class="group-block" id="groupB"></div>
            <div class="group-block" id="groupC"></div>
            <div class="group-block" id="groupD"></div>
          </div>
        </div>
        <div id="mvpArea" class="mvp-area" style="display:none;"></div>
      </div>

      <div class="table-container">
        <table class="leaderboard-table" id="leaderboardTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Team</th>
              <th class="hide-mobile">Group</th>
              <th class="hide-mobile">Matches</th>
              <th class="hide-mobile">Finish Pts</th>
              <th class="hide-mobile">Position Pts</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <tr class="coming-soon-row">
              <td colspan="7" style="text-align:center; color: var(--text-muted); font-style: italic;">Data Coming Soon</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="last-updated" id="lastUpdated">
        Last updated: --:--
      </div>
    </div>
  </section>
</Layout>

<style>
  /* Golden & Cyan Effects for Leading Team Banner */
  .leading-team-banner-with-effects {
    position: relative;
    margin-bottom: 40px;
    padding: 50px 40px;
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
    border: 3px solid rgba(255, 215, 0, 0.6);
    border-radius: 16px;
    text-align: center;
    overflow: hidden;
    box-shadow: 
      0 10px 60px rgba(255, 215, 0, 0.4),
      0 0 100px rgba(0, 242, 254, 0.2);
    backdrop-filter: blur(10px);
    min-height: 200px; /* Force height so particles are visible */
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }

  .leading-team-banner-with-effects .leading-team-text {
    position: relative;
    z-index: 10;
    font-size: 2.5rem;
    background: linear-gradient(90deg, #ffd700, #fff, #ffd700);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: text-shine 3s ease infinite;
    margin-bottom: 10px;
    text-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
    filter: drop-shadow(0 0 20px rgba(0, 242, 254, 0.5));
    width: 100%; /* Ensure full width for centering */
  }

  @keyframes text-shine {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 100% center; }
  }

  .effects-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
    overflow: hidden; /* Ensure particles don't spill out */
  }

  /* PULSE RINGS */
  .pulse-ring {
    position: absolute;
    top: 50%;
    left: 50%;
    border: 3px solid rgba(255, 215, 0, 0.7);
    border-radius: 50%;
    box-shadow: 
      0 0 20px rgba(255, 215, 0, 0.8),
      0 0 40px rgba(0, 242, 254, 0.6),
      inset 0 0 20px rgba(0, 242, 254, 0.4);
    animation: pulse-expand 2.5s ease-out infinite;
    transform: translate(-50%, -50%);
  }

  .pulse-ring:nth-child(1) { animation-delay: 0s; }
  .pulse-ring:nth-child(2) { animation-delay: 0.8s; }
  .pulse-ring:nth-child(3) { animation-delay: 1.6s; }

  @keyframes pulse-expand {
    0% {
      width: 30px;
      height: 30px;
      opacity: 1;
      transform: translate(-50%, -50%); /* Keeps it centered */
      border-color: rgba(255, 215, 0, 0.9);
    }
    50% {
      border-color: rgba(0, 242, 254, 0.7);
    }
    100% {
      width: 500px;
      height: 500px;
      opacity: 0;
      transform: translate(-50%, -50%); /* Keeps it centered */
      border-color: rgba(255, 215, 0, 0.3);
    }
  }

  /* PARTICLES CANVAS */
  .particles-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  /* CYBER BEAMS */
  .cyber-beams-container {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 100%;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }

  .cyber-beam {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 600px;
    height: 4px;
    background: linear-gradient(
      90deg, 
      transparent, 
      rgba(255, 215, 0, 0.9) 30%,
      rgba(255, 215, 0, 1) 50%,
      rgba(255, 215, 0, 0.9) 70%,
      transparent
    );
    box-shadow: 
      0 0 20px rgba(255, 215, 0, 0.9),
      0 0 40px rgba(0, 242, 254, 0.7),
      0 0 60px rgba(0, 242, 254, 0.4);
    transform-origin: 0% 50%;
    animation: cyber-rotate 6s linear infinite;
    filter: drop-shadow(0 0 10px rgba(0, 242, 254, 0.8));
  }

  .cyber-beam:nth-child(2) { animation-delay: -1.5s; }
  .cyber-beam:nth-child(3) { animation-delay: -3s; }
  .cyber-beam:nth-child(4) { animation-delay: -4.5s; }

  @keyframes cyber-rotate {
    from {
      transform: rotate(0deg);
      opacity: 0.5;
    }
    50% {
      opacity: 1;
    }
    to {
      transform: rotate(360deg);
      opacity: 0.5;
    }
  }

  @media (max-width: 768px) {
    .leading-team-banner-with-effects .leading-team-text { 
      font-size: 1.5rem; /* Smaller font for mobile */
      margin-bottom: 5px;
    }
    .leading-team-banner-with-effects { 
      padding: 30px 15px; 
      min-height: 150px;
    }
    /* Hide some effects on mobile to reduce clutter if needed */
    .cyber-beam {
      width: 300px; /* Shorter beams on mobile */
    }
    /* Fix registration button overlap */
    .floating-registration-badge {
       top: 100px !important; /* Move down to avoid header overlap */
    }
  }
</style>

<script>
  // Standings page logic
  const filterTabs = document.getElementById('filterTabs');
  const matchFilters = document.getElementById('matchFilters');
  const overallFilters = document.getElementById('overallFilters');

  filterTabs?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const btn = target.closest('.filter-btn') as HTMLElement;
    if (!btn) return;

    const filter = btn.dataset.filter;

    // Update active state
    filterTabs.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Show/hide match filters based on selection
    if (filter === 'all') {
      if (matchFilters) matchFilters.style.display = 'none';
      if (overallFilters) overallFilters.style.display = 'flex';
    } else if (filter === 'finals') {
      if (matchFilters) {
        matchFilters.style.display = 'flex';
        // Add extra match button for finals (6 matches)
        const existingBtns = matchFilters.querySelectorAll('.filter-btn');
        if (existingBtns.length === 5) {
          const m6 = document.createElement('button');
          m6.className = 'filter-btn btn-sm';
          m6.dataset.match = '6';
          m6.textContent = 'M6';
          matchFilters.appendChild(m6);
        }
      }
      if (overallFilters) overallFilters.style.display = 'none';
    } else {
      if (matchFilters) {
        matchFilters.style.display = 'flex';
        // Remove M6 button for day matches
        const m6Btn = matchFilters.querySelector('[data-match="6"]');
        if (m6Btn) m6Btn.remove();
      }
      if (overallFilters) overallFilters.style.display = 'none';
    }
  });

  // View toggle
  const viewToggle = document.getElementById('viewToggle');
  let isTableView = true;

  viewToggle?.addEventListener('click', () => {
    isTableView = !isTableView;
    const tableContainer = document.querySelector('.table-container') as HTMLElement;
    const overallContainer = document.getElementById('overallContainer');

    if (tableContainer) tableContainer.style.display = isTableView ? 'block' : 'none';
    if (overallContainer) overallContainer.style.display = isTableView ? 'none' : 'block';
  });

  // Match filter clicks
  matchFilters?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const btn = target.closest('.filter-btn') as HTMLElement;
    if (!btn) return;

    matchFilters.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });

  // Group filter clicks
  overallFilters?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const btn = target.closest('.filter-btn') as HTMLElement;
    if (!btn) return;

    overallFilters.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });

  // Particles Animation System
  let canvas: HTMLCanvasElement | null = null;
  let ctx: CanvasRenderingContext2D | null = null;
  let particles: any[] = [];
  let animationFrame: number | null = null;
  const particleCount = 50;
  const particleSpeed = 0.6;

  function initParticleCanvas(canvasElement: HTMLCanvasElement) {
    canvas = canvasElement;
    ctx = canvas.getContext('2d');
    if (!ctx) return;

    resizeCanvas();
    animateParticles();
  }

  function resizeCanvas() {
    if (!canvas) return;
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    initParticles();
  }

  function initParticles() {
    if (!canvas) return;
    particles = [];
    for (let i = 0; i < particleCount; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * particleSpeed,
        vy: (Math.random() - 0.5) * particleSpeed,
        size: Math.random() * 3 + 1
      });
    }
  }

  function animateParticles() {
    if (!ctx || !canvas) return;

    ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    particles.forEach((p, i) => {
      if (!ctx || !canvas) return;

      // Update position
      p.x += p.vx;
      p.y += p.vy;

      // Bounce off edges
      if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
      if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

      // Draw cyan halo
      ctx.fillStyle = 'rgba(0, 242, 254, 0.3)';
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size * 3, 0, Math.PI * 2);
      ctx.fill();

      // Draw golden particle with cyan shadow
      ctx.shadowColor = 'rgba(0, 242, 254, 0.8)';
      ctx.shadowBlur = 15;
      ctx.fillStyle = 'rgba(255, 215, 0, 0.9)';
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
      ctx.shadowBlur = 0;

      // Draw connections
      particles.slice(i + 1).forEach(p2 => {
        if (!ctx || !canvas) return;
        const dx = p.x - p2.x;
        const dy = p.y - p2.y;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < 120) {
          const opacity = 0.4 * (1 - dist / 120);

          // Cyan glow line
          ctx.strokeStyle = `rgba(0, 242, 254, ${opacity * 0.6})`;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(p.x, p.y);
          ctx.lineTo(p2.x, p2.y);
          ctx.stroke();

          // Golden line
          ctx.strokeStyle = `rgba(255, 215, 0, ${opacity})`;
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(p.x, p.y);
          ctx.lineTo(p2.x, p2.y);
          ctx.stroke();
        }
      });
    });

    animationFrame = requestAnimationFrame(animateParticles);
  }

  // Render Leading Team Banner with Effects
  async function renderLeadingTeamBanner() {
    const container = document.getElementById('leadingTeamBannerContainer');
    if (!container) return;

    try {
      const response = await fetch('/data/standings.json');
      if (!response.ok) return;

      const standings = await response.json();
      if (!standings || standings.length === 0) return;

      // ðŸŽ² RANDOM TEAM SELECTION LOGIC (For Testing)
      const randomIndex = Math.floor(Math.random() * standings.length);
      const leadingTeam = standings[randomIndex];

      if (!leadingTeam) return;

      // Handle casing
      const teamNameText = leadingTeam.teamName || leadingTeam.teamname || leadingTeam.name || "Unknown Team";

      // Create banner with effects
      // Use template literals correctly with backticks `
      const banner = document.createElement('div');
      banner.className = 'leading-team-banner-with-effects';

      banner.innerHTML = `
        <!-- EFFECTS LAYER -->
        <div class="effects-layer">
          <!-- Pulse Rings -->
          <div class="pulse-ring"></div>
          <div class="pulse-ring"></div>
          <div class="pulse-ring"></div>

          <!-- Particles Canvas -->
          <canvas class="particles-canvas" id="particlesCanvas"></canvas>

          <!-- Cyber Beams -->
          <div class="cyber-beams-container">
            <div class="cyber-beam"></div>
            <div class="cyber-beam"></div>
            <div class="cyber-beam"></div>
            <div class="cyber-beam"></div>
          </div>
        </div>

        <!-- BANNER CONTENT -->
        <h2 class="leading-team-text">` + escapeHtml(teamNameText) + ` is Leading ðŸ”¥</h2>
      `;

      container.innerHTML = '';
      container.appendChild(banner);

      // Initialize particle canvas after banner is rendered
      setTimeout(() => {
        const particleCanvas = document.getElementById('particlesCanvas') as HTMLCanvasElement;
        if (particleCanvas) {
          initParticleCanvas(particleCanvas);
        }
      }, 100);

    } catch (error) {
      console.log('Could not render leading team banner:', error);
    }
  }

  // Helper function to escape HTML
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Load leading team banner on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', renderLeadingTeamBanner);
  } else {
    renderLeadingTeamBanner();
  }

  // Handle window resize for canvas
  window.addEventListener('resize', () => {
    if (canvas) resizeCanvas();
  });
</script>
