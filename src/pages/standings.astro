---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Standings | SYNAPSE 2026" activePage="standings">
  <section class="leaderboard-section">
    <div class="container">

      <div class="live-status-banner">
        <div class="live-status-content">
          <span class="live-icon">üî¥</span>
          <span class="live-text">LIVE STANDINGS</span>
          <span class="live-icon">üî¥</span>
        </div>
      </div>

      <div class="page-header-box">
        <h1 class="page-title">Tournament Leaderboard</h1>
        <div id="leadingBannerContainer" class="leading-team-banner" style="display:none;">
          <span class="leader-label">CURRENT LEADER</span>
          <h2 id="leaderTeamName">LOADING...</h2>
          <div id="leaderStats" class="leader-stats"></div>
        </div>
      </div>

      <div class="filter-tabs" id="mainStageTabs">
        <button class="filter-btn active" onclick="setStage('overall')">OVERALL</button>
        <button class="filter-btn" onclick="setStage('qual1')">QUALIFIER 1</button>
        <button class="filter-btn" onclick="setStage('qual2')">QUALIFIER 2</button>
        <button class="filter-btn" onclick="setStage('finals')">FINALS</button>
      </div>

      <div id="layer2Container" class="mid-menu-container" style="display: none;">
        <div class="button-group" id="layer2Buttons"></div>
      </div>

      <div id="layer3Container" class="mid-menu-container" style="display: none;">
        <div class="button-group" id="layer3Buttons"></div>
      </div>

      <div class="content-grid">
        
        <div class="main-content-area">
           <div id="standingsContent" class="content-fade-in"></div>
        </div>

        <div class="sidebar-area">
          <div id="mvpCard" class="mvp-card">
            <div class="mvp-header">
              <span class="mvp-badge">MVP</span>
              <h3 id="mvpTitle">MATCH MVP</h3>
            </div>
            <div class="mvp-image-container">
               <div class="mvp-placeholder-img" id="mvpImage">üë§</div>
            </div>
            <div class="mvp-info">
              <h2 id="mvpPlayerName">TBD</h2>
              <h4 id="mvpTeamName">WAITING FOR DATA</h4>
            </div>
            <div class="mvp-stats-grid">
              <div class="stat-box">
                <span class="stat-label">KILLS</span>
                <span class="stat-value" id="mvpKills">-</span>
              </div>
              <div class="stat-box">
                <span class="stat-label">MATCHES</span>
                <span class="stat-value" id="mvpMatches">-</span>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </section>
</Layout>

<style is:global>
  /* üé® GRID LAYOUT */
  .content-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    margin-top: 2rem;
  }

  /* Desktop View: Split 70% Table / 30% MVP */
  @media (min-width: 992px) {
    .content-grid {
      grid-template-columns: 3fr 1fr;
      align-items: start;
    }
    .sidebar-area {
      position: sticky;
      top: 20px;
    }
  }

  /* üèÜ MVP CARD STYLES */
  .mvp-card {
    background: linear-gradient(145deg, rgba(20,20,20,0.9), rgba(40,10,10,0.95));
    border: 1px solid #ff4500;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 0 25px rgba(255, 69, 0, 0.15);
    position: relative;
    overflow: hidden;
    animation: fadeIn 0.6s ease;
  }

  .mvp-badge {
    background: #ff4500;
    color: white;
    font-weight: 800;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    letter-spacing: 1px;
    display: inline-block;
    margin-bottom: 5px;
  }

  .mvp-header h3 {
    margin: 0;
    color: #ff8855;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .mvp-image-container {
    margin: 1.5rem auto;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 3px solid #ff4500;
    box-shadow: 0 0 20px rgba(255, 69, 0, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    background: #111;
    overflow: hidden;
  }

  .mvp-placeholder-img {
    font-size: 3rem;
    color: #333;
  }

  .mvp-info h2 {
    color: #fff;
    margin: 0;
    font-size: 1.4rem;
    font-weight: 800;
    text-shadow: 0 0 10px rgba(0,0,0,0.5);
  }

  .mvp-info h4 {
    color: #aaa;
    margin: 0.2rem 0 1rem;
    font-size: 0.85rem;
    font-weight: 400;
  }

  .mvp-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    background: rgba(0,0,0,0.3);
    padding: 10px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.05);
  }

  .stat-box { display: flex; flex-direction: column; }
  .stat-label { font-size: 0.65rem; color: #888; text-transform: uppercase; }
  .stat-value { font-size: 1.1rem; color: #fff; font-weight: 700; }

  /* üìä TABLE STYLES */
  .table-container {
    width: 100%;
    overflow-x: auto;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
  }

  .leaderboard-table th, .leaderboard-table td {
    padding: 14px 12px;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    color: #eee;
  }

  .leaderboard-table th {
    background: rgba(255, 69, 0, 0.2);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 1px;
  }
  
  .leaderboard-table td:nth-child(2) { /* Team Name */
    text-align: left;
    font-weight: 700;
    color: #fff;
  }

  /* LEADING BANNER */
  .leading-team-banner {
    background: linear-gradient(90deg, rgba(20,10,0,0.9) 0%, rgba(50,20,0,0.9) 100%);
    border: 1px solid #ff4500;
    border-left: 6px solid #ff4500;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    margin: 1.5rem auto;
    max-width: 600px;
    box-shadow: 0 4px 30px rgba(255, 69, 0, 0.2);
    animation: fadeIn 0.5s ease;
  }
  
  .leader-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: #ff8855; display: block; margin-bottom: 0.5rem; }
  .leading-team-banner h2 { font-size: 2rem; margin: 0; color: #fff; text-shadow: 0 0 15px rgba(255, 69, 0, 0.6); }
  .leader-stats { margin-top: 0.5rem; font-size: 0.9rem; color: #ccc; }

  /* BUTTONS */
  .mid-menu-container { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: center; }
  .button-group { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
  .sub-btn { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: #bbb; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
  .sub-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .sub-btn.active { background: #ff4500; color: white; border-color: #ff4500; box-shadow: 0 0 10px rgba(255,69,0,0.4); }
  .filter-tabs { display: flex; gap: 10px; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap; }
  .filter-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px 24px; border-radius: 30px; cursor: pointer; font-weight: 700; transition: 0.3s; }
  .filter-btn.active { background: #ff4500; border-color: #ff4500; color: white; }

  /* UTILS */
  .wwcd-row { background: rgba(255, 215, 0, 0.1) !important; border-left: 3px solid gold !important; }
  .top-3-row { background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent); }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .live-status-banner { background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); border-radius: 4px; padding: 4px 12px; margin: 0 auto 1.5rem; width: fit-content; }
  .live-text { color: #ff4444; font-weight: 800; font-size: 0.75rem; letter-spacing: 1px; }
</style>

<script is:inline>
  let standingsData = [];
  let playersData = [];

  // ==============================================
  // üöÄ INITIALIZATION
  // ==============================================
  async function init() {
    try {
      // Fetch both Standings AND Players data
      const [sRes, pRes] = await Promise.all([
        fetch('/data/standings.json'),
        fetch('/data/players.json') // Make sure this file exists!
      ]);

      if(sRes.ok) standingsData = await sRes.json();
      if(pRes.ok) playersData = await pRes.json();
      
      // Default View
      setStage('overall');
    } catch (e) {
      console.error("Data Load Error:", e);
      document.getElementById('standingsContent').innerHTML = `<p style="text-align:center;color:red;">Error loading data.</p>`;
    }
  }

  // ==============================================
  // üïπÔ∏è NAVIGATION LOGIC
  // ==============================================

  window.setStage = (stage) => {
    // UI Updates
    document.querySelectorAll('#mainStageTabs .filter-btn').forEach(b => b.classList.remove('active'));
    const clickedBtn = Array.from(document.querySelectorAll('#mainStageTabs .filter-btn')).find(b => b.getAttribute('onclick').includes(stage));
    if(clickedBtn) clickedBtn.classList.add('active');

    const l2Div = document.getElementById('layer2Container');
    const l2Btns = document.getElementById('layer2Buttons');
    const l3Div = document.getElementById('layer3Container');

    l2Btns.innerHTML = '';
    l2Div.style.display = 'flex';
    l3Div.style.display = 'none';

    // Update MVP Context Title
    document.getElementById('mvpTitle').innerText = (stage === 'overall') ? "TOURNAMENT MVP" : "STAGE MVP";

    if (stage === 'overall') {
      renderButtons(l2Btns, [
        { label: 'Combined', fn: () => renderOverallTable('combined') },
        { label: 'Group A', fn: () => renderOverallTable('A') },
        { label: 'Group B', fn: () => renderOverallTable('B') },
        { label: 'Group C', fn: () => renderOverallTable('C') },
        { label: 'Group D', fn: () => renderOverallTable('D') }
      ]);
    } 
    else if (stage === 'qual1') {
      renderButtons(l2Btns, [
        { label: 'Day 1', fn: () => setupMatchLayer('day1') },
        { label: 'Day 2', fn: () => setupMatchLayer('day2') }
      ]);
    }
    else if (stage === 'qual2') {
      renderButtons(l2Btns, [
        { label: 'Day 3', fn: () => setupMatchLayer('day3') }
      ]);
    }
    else if (stage === 'finals') {
      renderButtons(l2Btns, [
        { label: 'Finals Day 1', fn: () => setupMatchLayer('finals') }
      ]);
    }
  };

  function setupMatchLayer(dayKey) {
    const l3Div = document.getElementById('layer3Container');
    const l3Btns = document.getElementById('layer3Buttons');
    l3Div.style.display = 'flex';
    l3Btns.innerHTML = '';

    const buttons = [
      { label: 'Day Overall', fn: () => { 
          renderDayOverall(dayKey); 
          document.getElementById('mvpTitle').innerText = "DAY MVP"; 
      }},
      { label: 'Match 1', fn: () => { 
          renderSingleMatch(dayKey, 'M1'); 
          document.getElementById('mvpTitle').innerText = "MATCH 1 MVP"; 
      }},
      { label: 'Match 2', fn: () => { renderSingleMatch(dayKey, 'M2'); document.getElementById('mvpTitle').innerText = "MATCH 2 MVP"; }},
      { label: 'Match 3', fn: () => { renderSingleMatch(dayKey, 'M3'); document.getElementById('mvpTitle').innerText = "MATCH 3 MVP"; }},
      { label: 'Match 4', fn: () => { renderSingleMatch(dayKey, 'M4'); document.getElementById('mvpTitle').innerText = "MATCH 4 MVP"; }}
    ];

    renderButtons(l3Btns, buttons);
  }

  function renderButtons(container, options) {
    container.innerHTML = options.map((opt, index) => 
      `<button class="sub-btn ${index === 0 ? 'active' : ''}" id="btn-${index}">
        ${opt.label}
      </button>`
    ).join('');
    options.forEach((opt, index) => {
      container.querySelector(`#btn-${index}`).addEventListener('click', function() {
        container.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        opt.fn();
      });
    });
    if(options.length > 0) options[0].fn();
  }

  // ==============================================
  // üìä RENDERING
  // ==============================================

  function renderOverallTable(groupFilter) {
    let data = [...standingsData];
    if (groupFilter !== 'combined') data = data.filter(t => t.group === groupFilter);
    data.sort((a, b) => b.stats.overall.total_pts - a.stats.overall.total_pts);

    updateLeaderBanner(data, 'overall');
    calculateMVP(data, 'overall'); // Update MVP

    const html = `
      <div class="table-container">
        <table class="leaderboard-table">
          <thead><tr><th>Rank</th><th>Team</th><th>Matches</th><th>Finish Pts</th><th>Place Pts</th><th>Total Pts</th></tr></thead>
          <tbody>
            ${data.map((t, i) => `
              <tr class="${i < 3 ? 'top-3-row' : ''}">
                <td>#${i + 1}</td>
                <td><span style="color:#ff4500; margin-right:5px;">[${t.team_logo}]</span> ${t.team_name}</td>
                <td>${t.stats.overall.matches_played}</td>
                <td>${t.stats.overall.finish_pts}</td>
                <td>${t.stats.overall.pos_pts}</td>
                <td style="font-weight:bold; color:#ff4500;">${t.stats.overall.total_pts}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;
    document.getElementById('standingsContent').innerHTML = html;
  }

  function renderSingleMatch(dayKey, matchKey) {
    const matchData = standingsData.map(t => {
      const mStats = t.stats[dayKey]?.[matchKey] || { place_pts: 0, kill_pts: 0, total: 0, wwcd: false };
      return { name: t.team_name, logo: t.team_logo, team_id: t.team_id, ...mStats };
    });
    matchData.sort((a, b) => b.total - a.total);

    updateLeaderBanner(matchData, 'match');
    calculateMVP(matchData, matchKey, dayKey); // Update MVP based on specific match

    const html = `
      <div class="table-container">
        <table class="leaderboard-table">
          <thead><tr><th>Rank</th><th>Team</th><th>Place Pts</th><th>Kill Pts</th><th>Total Pts</th><th>WWCD</th></tr></thead>
          <tbody>
            ${matchData.map((t, i) => `
              <tr class="${t.wwcd ? 'wwcd-row' : ''}">
                <td>${i + 1}</td>
                <td><span style="color:#aaa;">[${t.logo}]</span> ${t.name}</td>
                <td>${t.place_pts}</td>
                <td>${t.kill_pts}</td>
                <td style="font-weight:bold;">${t.total}</td>
                <td>${t.wwcd ? 'üèÜ' : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;
    document.getElementById('standingsContent').innerHTML = html;
  }

  function renderDayOverall(dayKey) {
    const calculatedData = standingsData.map(t => {
      const dayObj = t.stats[dayKey] || {};
      let dTotal = 0, dKill = 0, dPlace = 0, dWWCD = 0;
      ['M1','M2','M3','M4'].forEach(m => {
        if(dayObj[m]) {
          dTotal += dayObj[m].total || 0;
          dKill += dayObj[m].kill_pts || 0;
          dPlace += dayObj[m].place_pts || 0;
          if(dayObj[m].wwcd) dWWCD++;
        }
      });
      return { name: t.team_name, logo: t.team_logo, team_id: t.team_id, total: dTotal, kill: dKill, place: dPlace, wwcd: dWWCD };
    });
    calculatedData.sort((a, b) => b.total - a.total);

    updateLeaderBanner(calculatedData, 'day_sum');
    calculateMVP(calculatedData, 'day_sum', dayKey); // Update MVP for the day

    const html = `
      <div class="table-container">
        <table class="leaderboard-table">
          <thead><tr><th>Rank</th><th>Team</th><th>WWCD</th><th>Place Pts</th><th>Kill Pts</th><th>Day Total</th></tr></thead>
          <tbody>
            ${calculatedData.map((t, i) => `
              <tr class="${i < 3 ? 'top-3-row' : ''}">
                <td>#${i + 1}</td>
                <td><span style="color:#aaa;">[${t.logo}]</span> ${t.name}</td>
                <td>${t.wwcd > 0 ? 'üèÜ x'+t.wwcd : '-'}</td>
                <td>${t.place}</td>
                <td>${t.kill}</td>
                <td style="font-weight:bold; color:#ff4500;">${t.total}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;
    document.getElementById('standingsContent').innerHTML = html;
  }

  // ==============================================
  // üèÜ LEADING BANNER & MVP LOGIC
  // ==============================================

  function updateLeaderBanner(sortedData, context) {
    const banner = document.getElementById('leadingBannerContainer');
    if (!sortedData || sortedData.length === 0) { banner.style.display = 'none'; return; }
    banner.style.display = 'block';

    const leader = sortedData[0];
    let totalPts = 0;
    let subInfo = "";

    if (context === 'overall') {
      totalPts = leader.stats.overall.total_pts;
      subInfo = `${leader.stats.overall.wwcd_count} WWCD | ${leader.stats.overall.finish_pts} Finishes`;
      document.getElementById('leaderTeamName').innerText = leader.team_name;
    } else {
      totalPts = leader.total;
      subInfo = `${leader.place_pts || leader.place} Place Pts | ${leader.kill_pts || leader.kill} Kill Pts`;
      document.getElementById('leaderTeamName').innerText = leader.name;
    }
    document.getElementById('leaderStats').innerHTML = `<strong>${totalPts} PTS</strong> <span style="opacity:0.6; margin:0 8px;">/</span> ${subInfo}`;
  }

  function calculateMVP(contextData, scope, dayKey) {
    // 1. If Players JSON is empty, use Placeholder logic based on Teams
    if(!playersData || playersData.length === 0) {
      document.getElementById('mvpPlayerName').innerText = "No Data";
      document.getElementById('mvpTeamName').innerText = "Player stats unavailable";
      return;
    }

    // 2. Logic to find MVP
    // NOTE: This assumes players.json has { team_id, name, kills: { overall, day1: { M1: 5 } } } structure
    // If exact structure is unknown, this is a best-effort implementation
    
    let bestPlayer = null;
    let maxKills = -1;

    playersData.forEach(p => {
      let k = 0;
      if (scope === 'overall') {
        k = p.stats?.overall?.kills || 0;
      } 
      else if (scope === 'day_sum') {
        // Sum kills for specific day
        const d = p.stats?.[dayKey] || {};
        Object.values(d).forEach(m => k += (m.kills || 0));
      }
      else {
        // Specific Match
        k = p.stats?.[dayKey]?.[scope]?.kills || 0;
      }

      if (k > maxKills) {
        maxKills = k;
        bestPlayer = p;
      }
    });

    // 3. Update DOM
    if (bestPlayer) {
      document.getElementById('mvpPlayerName').innerText = bestPlayer.name || "Unknown";
      
      // Find Team Name
      const team = standingsData.find(t => t.team_id === bestPlayer.team_id);
      document.getElementById('mvpTeamName').innerText = team ? team.team_name : "Free Agent";
      
      document.getElementById('mvpKills').innerText = maxKills;
      document.getElementById('mvpMatches').innerText = (scope === 'overall') ? (bestPlayer.matches_played || 'All') : 1;
      
      // Set Image if available, else placeholder
      const imgContainer = document.getElementById('mvpImage');
      if(bestPlayer.image) {
        imgContainer.innerHTML = `<img src="${bestPlayer.image}" style="width:100%; height:100%; object-fit:cover;">`;
      } else {
        imgContainer.innerHTML = `üë§`;
      }
    }
  }

  init();
</script>
