---
import Layout from '../layouts/Layout.astro';
import teamData from 'data/team.json';
---

<Layout title="Teams | MAVERICKS x SYNAPSE BGMI 2026" description="SYNAPSE MAMC BGMI 2026 - Participating Teams. Meet the squads competing for glory." activePage="teams">
  <section class="section" style="padding-top: 150px; background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9));">
    <div class="container">
      <h1 class="section-title" style="margin-bottom: 20px;">Competing Teams</h1>
      <p style="text-align: center; color: var(--text-secondary); max-width: 700px; margin: 0 auto 2rem;">Meet the elite squads from colleges across the nation battling for the ultimate title at Synapse 2026.</p>

      <div class="disclaimer">
        <i class="fas fa-info-circle" style="color:var(--accent-cyan); margin-right:8px;"></i>
        <strong>Note:</strong> Team names and player names shown are as registered by participants.
      </div>

      <div class="team-search-container">
        <div class="search-wrapper">
          <input type="text" id="teamSearch" class="team-search-input" placeholder="Search by Team Name or Player...">
          <i class="fas fa-search search-icon"></i>
        </div>
      </div>

      <div class="teams-grid" id="teamsGrid">
        {teamData.map((team) => (
          <div class="team-card">
            <div class="team-header">
              <div class="team-logo-small">{team.logo}</div>
              <h3 class="team-name">{team.name}</h3>
            </div>
            <div class="player-list">
              {team.players.map((player) => (
                <div class="player-row">
                  <span class="player-name">
                    <i class={`fas ${player.icon}`}></i> {player.name}
                    {player.isIGL && <span class="igl-badge">IGL</span>}
                  </span>
                </div>
              ))}
            </div>
            <div class="team-footer">
              <span class="team-group">{team.group}</span>
              <span class="team-college">{team.college}</span>
            </div>
          </div>
        ))}

        <div class="no-results" id="noResults">
          <h3 style="color: var(--accent-red);">No teams found matching your search.</h3>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script is:inline>
  console.log('='.repeat(70));
  console.log('TEAMS PAGE - WITH FIRE EFFECT ON LEADING CARD');
  console.log('='.repeat(70));

  const searchInput = document.getElementById('teamSearch');
  const teamCards = document.querySelectorAll('.team-card');
  const noResults = document.getElementById('noResults');

  // Search functionality
  searchInput?.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    let hasResults = false;

    teamCards.forEach(card => {
      const teamName = card.querySelector('.team-name')?.textContent?.toLowerCase() || '';
      const players = card.querySelector('.player-list')?.textContent?.toLowerCase() || '';

      if (teamName.includes(searchTerm) || players.includes(searchTerm)) {
        card.style.display = 'flex';
        hasResults = true;
      } else {
        card.style.display = 'none';
      }
    });

    if (noResults) {
      noResults.style.display = hasResults ? 'none' : 'block';
    }
  });

  // ========================================
  // CANVAS FIRE PARTICLE SYSTEM
  // ========================================

  class FireParticle {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.size = Math.random() * 6 + 1.5;
      this.speedY = Math.random() * 2.5 + 0.8;
      this.speedX = (Math.random() - 0.5) * 1.5;
      this.life = 1;
      this.decay = Math.random() * 0.02 + 0.008;
      this.color = this.getFireColor();
    }

    getFireColor() {
      const colors = [
        { r: 255, g: 69, b: 0, a: 0.9 },
        { r: 255, g: 140, b: 0, a: 0.9 },
        { r: 255, g: 200, b: 0, a: 0.8 },
        { r: 255, g: 215, b: 0, a: 0.7 },
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    update() {
      this.y -= this.speedY;
      this.x += this.speedX;
      this.life -= this.decay;
      this.size *= 0.97;
    }

    draw(ctx) {
      if (this.life <= 0) return;

      const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size);
      gradient.addColorStop(0, `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.life * this.color.a})`);
      gradient.addColorStop(0.5, `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.life * 0.5})`);
      gradient.addColorStop(1, `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, 0)`);

      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      ctx.fill();
    }

    isAlive() {
      return this.life > 0;
    }
  }

  class CardFireEffect {
    constructor(element) {
      this.element = element;
      this.canvas = document.createElement('canvas');
      this.ctx = this.canvas.getContext('2d');
      this.particles = [];
      this.animationId = null;
      this.setupCanvas();
      this.animate();
      console.log('ðŸ”¥ Card fire effect initialized');
    }

    setupCanvas() {
      this.canvas.style.position = 'absolute';
      this.canvas.style.top = '0';
      this.canvas.style.left = '0';
      this.canvas.style.width = '100%';
      this.canvas.style.height = '100%';
      this.canvas.style.pointerEvents = 'none';
      this.canvas.style.zIndex = '1';
      this.canvas.style.borderRadius = 'inherit';

      const rect = this.element.getBoundingClientRect();
      this.canvas.width = rect.width;
      this.canvas.height = rect.height;

      this.element.style.position = 'relative';
      this.element.style.overflow = 'visible';
      this.element.appendChild(this.canvas);

      window.addEventListener('resize', () => this.handleResize());
    }

    handleResize() {
      const rect = this.element.getBoundingClientRect();
      this.canvas.width = rect.width;
      this.canvas.height = rect.height;
    }

    createParticles() {
      const width = this.canvas.width;
      const height = this.canvas.height;

      for (let i = 0; i < 3; i++) {
        const x = Math.random() * width;
        const y = height - 5;
        this.particles.push(new FireParticle(x, y));
      }
    }

    animate() {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

      this.createParticles();

      this.particles = this.particles.filter(particle => {
        particle.update();
        particle.draw(this.ctx);
        return particle.isAlive();
      });

      this.animationId = requestAnimationFrame(() => this.animate());
    }

    destroy() {
      if (this.animationId) {
        cancelAnimationFrame(this.animationId);
      }
      if (this.canvas.parentNode) {
        this.canvas.parentNode.removeChild(this.canvas);
      }
    }
  }

  // ========================================
  // APPLY FIRE EFFECT TO LEADING TEAM
  // ========================================

  let fireEffectInstance = null;

  function applyLeadingTeamEffect() {
    console.log('\n[1/3] Fetching standings...');

    fetch('/data/standings.json')
      .then(r => {
        console.log('Response status:', r.status);
        if (!r.ok) throw new Error('Standings not found');
        return r.json();
      })
      .then(standings => {
        console.log('âœ… Standings loaded:', standings.length, 'teams');

        console.log('\n[2/3] Finding leading team...');
        const sortedTeams = [...standings].sort((a, b) => 
          (b.stats?.overall?.total_pts || 0) - (a.stats?.overall?.total_pts || 0)
        );
        const leadingTeam = sortedTeams[0];

        if (!leadingTeam) {
          console.error('âŒ No leading team found');
          return;
        }

        console.log('âœ… Leading team:', leadingTeam.team_name);

        console.log('\n[3/3] Applying fire effect to card...');
        const normalizeTeamName = (name) => name.toLowerCase().trim().replace(/\s+/g, ' ');
        const normalizedLeadingTeamName = normalizeTeamName(leadingTeam.team_name);

        let matched = false;
        teamCards.forEach(card => {
          const teamNameElement = card.querySelector('.team-name');
          if (!teamNameElement) return;

          const teamName = normalizeTeamName(teamNameElement.textContent || '');

          if (teamName === normalizedLeadingTeamName) {
            card.classList.add('leading-team');

            if (!card.querySelector('.leading-team-badge')) {
              const badge = document.createElement('div');
              badge.className = 'leading-team-badge';
              badge.innerHTML = 'ðŸ‘‘ LEADING';

              badge.style.position = 'absolute';
              badge.style.top = '-8px';
              badge.style.right = '-8px';
              badge.style.background = 'linear-gradient(135deg, #ff4500, #ff8c00)';
              badge.style.color = 'white';
              badge.style.padding = '6px 14px';
              badge.style.borderRadius = '20px';
              badge.style.fontSize = '0.75rem';
              badge.style.fontWeight = '700';
              badge.style.textTransform = 'uppercase';
              badge.style.letterSpacing = '1px';
              badge.style.zIndex = '1000';
              badge.style.boxShadow = '0 0 20px rgba(255,69,0,0.8), 0 2px 8px rgba(0,0,0,0.5)';
              badge.style.border = '2px solid rgba(255,215,0,0.5)';
              badge.style.display = 'block';
              badge.style.whiteSpace = 'nowrap';

              card.style.position = 'relative';
              card.style.overflow = 'visible';
              card.appendChild(badge);
            }

            setTimeout(() => {
              if (!card.dataset.fireInitialized) {
                try {
                  fireEffectInstance = new CardFireEffect(card);
                  card.dataset.fireInitialized = 'true';
                  console.log('âœ… Fire particles added to card:', teamName);
                } catch (err) {
                  console.error('âŒ Fire effect failed:', err);
                }
              }
            }, 300);

            matched = true;
          }
        });

        if (!matched) {
          console.warn('âš ï¸ Leading team card not found');
        }

        console.log('\n' + '='.repeat(70));
        console.log('TEAMS PAGE SETUP COMPLETE');
        console.log('='.repeat(70));
      })
      .catch(err => {
        console.error('âŒ Failed:', err.message);
      });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyLeadingTeamEffect);
  } else {
    applyLeadingTeamEffect();
  }

  window.addEventListener('beforeunload', () => {
    if (fireEffectInstance) {
      fireEffectInstance.destroy();
    }
  });
</script>
